![CScript](media/cscript.png)  
[![Chat on Discord](https://img.shields.io/discord/754884471324672040?style=for-the-badge)](https://discord.gg/tPWjMwK)
[![Follow on Bluesky](https://img.shields.io/badge/Bluesky-tinyBigGAMES-blue?style=for-the-badge&logo=bluesky)](https://bsky.app/profile/tinyBigGAMES.bsky.social)

# ğŸ…²ğŸ†‚cript

**ğŸ…²ğŸ†‚cript** represents a sophisticated ğŸ…²99 scripting engine meticulously crafted for experienced ğŸ§‘â€ğŸ’» Delphi developers. Leveraging the compact yet highly versatile **TinyCC** compiler, **ğŸ…²ğŸ†‚cript** seamlessly integrates âš™ï¸ dynamic backend code generation into the Delphi development environment. With **ğŸ…²ğŸ†‚cript**, Delphi developers can ğŸ› ï¸ compile and execute ğŸ…² scripts at runtime, directly in ğŸ’¾ memory, and generate output in the form of ğŸªŸ Win64 executables (.exe), dynamic-link libraries (.dll), or ğŸ“‚ object files (.obj).

### âœ¨ Features

- **âš™ï¸ Dynamic Code Generation**: Facilitates runtime ğŸ› ï¸ compilation and execution of ğŸ…²99 code directly within the Delphi application context.
- **ğŸ–¥ï¸ Versatile Output Options**: Supports in-memory execution alongside output to executable, DLL, or object file formats.
- **ğŸ“¦ Effortless Integration with ğŸ…² Libraries**: Capable of loading and interacting with compiled modules, including `.dll`, `.a`, and `.lib` files.
- **ğŸ“‚ Embedded Resources**: TinyCC runtime components (.h, .a, .o files) are encapsulated within a compressed zip resource and linked directly into your Delphi executable, thus minimizing ğŸ—‚ï¸ file system dependencies while ensuring runtime availability.
- **âš ï¸ Customizable Error Handling**: Offers the ability to assign custom error handlers, streamlining ğŸ debugging and enabling robust error management.
- **ğŸ” Full Symbol Access**: Provides direct access to symbols generated by the compiled code and to symbols within dynamically loaded modules, simplifying the integration of complex functionalities.

### ğŸ› ï¸ How It Works

**ğŸ…²ğŸ†‚cript** employs **TinyCC**, which is statically linked into the Delphi runtime, to compile and execute ğŸ…² code dynamically. All critical ğŸ…² runtime I/O operationsâ€”such as `open`, `close`, `read`, and `lseek`â€”are re-routed to Delphi-native implementations. Typically, TinyCC would require runtime files to be available separately; however, in **ğŸ…²ğŸ†‚cript**, these files are stored within the Delphi executable itself as compressed resources, resulting in a ğŸ“¦ self-contained virtualized I/O model. When **TinyCC** requests access to runtime files, a custom Delphi I/O handler checks the embedded zip archive, thereby ensuring a seamless, efficient, and isolated execution environment.

### ğŸ§© Integration with Delphi

**ğŸ…²ğŸ†‚cript** functions as a conduit to harness the capabilities of ğŸ…²99 code within the Delphi development framework. Whether it involves optimizing particular operations for âš¡ enhanced performance, interfacing with pre-existing ğŸ…² libraries, or augmenting Delphi's feature set with the expressive capabilities of ğŸ…², **ğŸ…²ğŸ†‚cript** provides a cohesive and sophisticated development toolset.

### ğŸ—ï¸ Key Classes and Types

**TCScript** is the primary interface for engaging with **ğŸ…²ğŸ†‚cript** functionalities. Below is an overview of its core components:

#### ğŸ…ƒCScriptOutputType
- `csMEMORY`: ğŸ› ï¸ Compile and execute scripts entirely in memory.
- `csLib`: Generate ğŸ“‚ object files (`.obj`).
- `csEXE`: Generate a ğŸªŸ Win64 executable.
- `csDLL`: Generate a ğŸ“„ dynamic-link library.

#### ğŸ…ƒCScriptExeSubsystem
- `csCONSOLE`: Targets ğŸ® console application subsystems.
- `csGUI`: Targets ğŸ¨ graphical user interface subsystems.

#### ğŸ…ƒCScript Class Overview
- **ğŸ—ï¸ Construction and Destruction**
  - `constructor Create()`: ğŸ› ï¸ Initializes an instance of **TCScript**.
  - `destructor Destroy()`: ğŸ’£ Releases resources tied to the **TCScript** instance.
- **âš ï¸ Error Handling**
  - `procedure SetErrorHandler(const ASender: Pointer; const AHandler: TCScriptErrorEvent)`: Assigns a custom error handler for error management.
  - `procedure GetErrorHandler(var ASender: Pointer; var AHandler: TCScriptErrorEvent)`: Retrieves the currently assigned error handler.
- **ğŸ“‚ Path Management**
  - `function AddLibraryPath(const APath: string): Boolean`: Registers a ğŸ“ library path for the compiler.
  - `function AddIncludePath(const APath: string): Boolean`: Registers an include path for locating header files.
- **ğŸ› ï¸ Compilation and Execution**
  - `function SetOutputType(const AOutputType: TCScriptOutputType): Boolean`: Specifies the desired output type for script compilation.
  - `function CompileString(const ABuffer: string): Boolean`: Compiles a provided string of ğŸ…² code.
  - `function AddFile(const AFilename: string): Boolean`: Adds a ğŸ“„ source file to the compilation unit.
  - `function Run(): Boolean`: Executes the compiled script.
- **ğŸ“¦ Library Management**
  - `function AddLibrary(const AName: string): Boolean`: Adds an external library to be dynamically linked during execution.
- **ğŸ” Symbol Management**
  - `procedure AddSymbol(const AName: string; AValue: Pointer)`: Registers a symbol to the scripting context.
  - `function GetSymbol(const AName: string): Pointer`: Retrieves the address of a registered symbol.
- **ğŸ› ï¸ Utility Functions**
  - `procedure Reset()`: Resets the **TCScript** instance, clearing previous states.
  - `function SaveOutputFile(const AFilename: string): Boolean`: Saves the compiled output to a specified ğŸ“„ file.

### ğŸ“– Example Usage

The following example illustrates how to instantiate **TCScript**, add a file for compilation, and execute the resulting script:

```delphi
procedure CScriptErrorEvent(const ASender: Pointer; const AText: string);
begin
  WriteLn(AText);
end;

procedure AddFileRun();
var
  LCScript: TCScript;
begin
  LCScript := TCScript.Create();
  try
    // Set the âš ï¸ error handler
    LCScript.SetErrorHandler(nil, CScriptErrorEvent);
    
    // Configure the output type for in-memory execution
    LCScript.SetOutputType(csMEMORY);
    
    // Add include and library paths
    LCScript.AddIncludePath('res/include');
    LCScript.AddLibraryPath('res/lib');
    
    // Add the ğŸ…² source file to the scripting engine
    LCScript.AddFile('res/src/test01.c');
    
    // Execute the compiled script
    if not LCScript.Run() then
      WriteLn('âŒ Failed to execute script.');
  finally
    // Release resources
    LCScript.Free();
  end;
end;
```

### Prerequisites
- **Delphi 12 CE or higher** ğŸ–¥ï¸
- **Windows 10 or higher** ğŸªŸ
- **Tested on Windows 11 64-bit (23H2), Delphi 12.2** âœ…

### ğŸ› ï¸ Installation

To integrate **ğŸ…²ğŸ†‚cript** into your Delphi project:

1. **â¬‡ï¸ Download the latest version** from the **ğŸ…²ğŸ†‚cript** repository.
2. **ğŸ“¦ Unzip** to your desired location.
3. **â• Add the `src` folder** to the Delphi search path.
4. **â• Add `ğŸ…²ğŸ†‚cript` to your project's uses section**.
5. **ğŸ“– See the examples** for more information on usage.

### ğŸ¤ Contributions

Contributions to **ğŸ…²ğŸ†‚cript** are highly encouraged. Please feel free to submit issues, suggest new features, or create pull requests to expand the capabilities and robustness of the scripting engine.

### ğŸ“ License

**ğŸ…²ğŸ†‚cript** is distributed under the ğŸ†“ BSD-3-Clause license. For more details, refer to the `LICENSE` file.

### Support

- <a href="https://github.com/tinyBigGAMES/CScript/issues" target="_blank">Issues</a>
- <a href="https://github.com/tinyBigGAMES/CScript/discussions" target="_blank">Discussions</a>
- <a href="https://github.com/tinyBigGAMES/CScript/wiki" target="_blank">Wiki</a>
- <a href="https://learndelphi.org/" target="_blank">Learn Delphi</a>

---

Whether you seek to âš¡ enhance computational performance, interface seamlessly with existing ğŸ…² libraries, or expand the features of your Delphi applications, **ğŸ…²ğŸ†‚cript** provides a powerful, integrated solution for combining the strengths of Delphi and ğŸ…²99 programming.

ğŸ”“ Unlock new possibilities with **ğŸ…²ğŸ†‚cript** and elevate your Delphi development experience through hybrid programming techniques.


<p align="center">
<img src="media/delphi.png" alt="Delphi">
</p>
<h5 align="center">

Made with :heart: in Delphi
</h5>

